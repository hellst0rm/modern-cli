name: Build Packages

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'packages/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'packages/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  test-configs:
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Arch Linux environment
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel git fish lua jq yq taplo-cli

    - name: Verify tools installation
      run: |
        echo "Verifying installed tools..."
        jq --version || echo "jq not found"
        yq --version || echo "yq not found" 
        taplo --version || echo "taplo not found"
        lua -v || echo "lua not found"
        fish --version || echo "fish not found"
    
    - name: Test configurations
      run: |
        ./scripts/test-configs.sh all

  build-packages:
    needs: test-configs
    runs-on: ubuntu-latest
    container:
      image: archlinux:latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Arch Linux environment
      run: |
        pacman -Syu --noconfirm
        pacman -S --noconfirm base-devel git sudo
    
    - name: Create build user
      run: |
        useradd -m builder
        echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        chown -R builder:builder .
    
    - name: Build all packages
      run: |
        su builder -c "./scripts/update-packages.sh build"
    
    - name: List built packages
      run: |
        echo "Built packages:"
        ls -la x86_64/
        
        echo "Repository database:"
        ls -la x86_64/modern-cli-repo.*
    
    - name: Upload packages artifact
      uses: actions/upload-artifact@v4
      with:
        name: arch-packages-${{ github.sha }}
        path: x86_64/
        retention-days: 30
    
    - name: Upload build summary
      run: |
        echo "## Build Summary" > build-summary.md
        echo "- **Commit:** ${{ github.sha }}" >> build-summary.md
        echo "- **Branch:** ${{ github.ref_name }}" >> build-summary.md
        echo "- **Built packages:**" >> build-summary.md
        for pkg in x86_64/*.pkg.tar.zst; do
          if [ -f "$pkg" ]; then
            echo "  - $(basename "$pkg")" >> build-summary.md
          fi
        done
        
        echo "- **Repository files:**" >> build-summary.md
        echo "  - modern-cli-repo.db: $(ls -lh x86_64/modern-cli-repo.db | awk '{print $5}')" >> build-summary.md
        echo "  - modern-cli-repo.files: $(ls -lh x86_64/modern-cli-repo.files | awk '{print $5}')" >> build-summary.md
    
    - name: Upload build summary
      uses: actions/upload-artifact@v4
      with:
        name: build-summary-${{ github.sha }}
        path: build-summary.md
        retention-days: 30

  build-status:
    needs: [test-configs, build-packages]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: Build success notification
      if: needs.build-packages.result == 'success'
      run: |
        echo "âœ… All packages built successfully!"
        echo "ğŸ“¦ Artifacts available for deployment"
    
    - name: Build failure notification
      if: needs.build-packages.result == 'failure'
      run: |
        echo "âŒ Package build failed!"
        echo "ğŸ” Check build logs for details"